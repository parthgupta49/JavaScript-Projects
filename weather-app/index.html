<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather-App</title>
    <link rel="stylesheet" href="./main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Merriweather+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <!-- <script src="./script.js" defer></script> -->

</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Merriweather Sans', sans-serif;
    }

    body {
        width: 100vw;
        height: 100vh;
        overflow-x: hidden;
        scroll-behavior: smooth;
    }

    .wrapper {
        background-image: linear-gradient(160deg, #112d4e 0%, #3f72af 100%);

    }

    .searchWeatherContainer {
        display: none;
    }

    .searchWeatherContainer.active {
        display: flex;
        flex-direction: row;
    }

    .loader {
        display: none;
    }

    .loader.active {
        display: flex;
        flex-direction: column;

    }

    .grantLocationContainer {
        display: none;
    }

    .grantLocationContainer.active {
        display: flex;
        flex-direction: column;
    }

    .tab.current-tab {
        background-color: rgba(219, 226, 239, 0.5);
        border-radius: 4px;

    }

    .error {
        display: none;
    }

    .error.active {
        display: flex;
        flex-direction: column;
    }

    .cityResults {
        display: none;
    }

    .cityResults.active {
        display: flex;
        flex-direction: column;
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />

<body>
    <!-- :root {
    --colorDark1: #112D4E;
    --colorDark2: #3F72AF;
    --colorLight1: #DBE2EF;
    --colorLight2: #F9F7F7;
} -->
    <div class="wrapper min-h-[800px]  bg-[#112d4e] text-[#DBE2EF]  flex justify-center">
        <div class="container w-full max-w-[550px] h-full flex flex-col gap-[4rem] pt-10">
            <h1 class="text-4xl font-bold text-center ">WEATHER APP</h1>
            <div class="flex justify-between text-[1.05rem]">
                <button class="tab px-[0.65rem]" data-userWeather class=" tracking-wider">Your Weather</button>
                <button class="tab px-[0.65rem]" data-searchWeatherButton class="tracking-wider">Search Weather</button>
            </div>

            <div class="weather-container">

                <!-- grant location container -->
                <div class=" justify-center gap-3 items-center  grantLocationContainer text-white"
                    data-grantLocationContainer>
                    <img src="./assets/location.png" alt="" width="80" class="">
                    <p class="text-3xl mt-4 leading-[2rem] text-white">Grant Location Access</p>
                    <p class="text-[#DBE2EF]">Allow Access To Get Weather Information</p>
                    <button class="mt-3 bg-[#3F72AF] px-6 py-2 rounded-md text-sm" data-grantLocationButton>GRANT
                        ACCESS</button>
                </div>


                <!-- search box -->
                <div class="  searchWeatherContainer mb-10" data-searchWeatherContainer>
                    <form class="flex gap-4 w-full" id="form-data">

                        <input type="text" name="city" id="city" placeholder="Search for city..."
                            class=" outline-none focus:border-[0.1rem] border-white  rounded-lg w-[90%] px-4 placeholder:text-white text-white"
                            style="
                        background-color : rgba(219, 226, 239, 0.5);" data-inputBox>
                        <button type="submit"
                            class="rounded-full bg-[#3f71af81] w-9 h-9 flex justify-center items-center"><i
                                class="fa-solid fa-magnifying-glass" data-searchIcon></i></button>
                    </form>
                    <!-- search icon -->
                </div>
                <!-- loader screen -->
                <div class=" loader justify-center items-center" data-loader>
                    <img src="./assets/loading.gif" width="150" alt="">
                    <p class="text-xl font-bold">LOADING</p>
                </div>


                <!-- results div will be invisible until the user presses on search button -->
                <div class=" gap-10 cityResults " data-userInfoContainer>
                    <!-- 1st -->
                    <div class="flex flex-col justify-center items-center gap-2">
                        <div class="flex justify-center items-center gap-2">
                            <span data-cityName class="text-3xl">
                                <!-- city comes here -->

                            </span>
                            <img src="" width="30" data-countryIcon>
                        </div>
                        <!-- Weather status - clear, cloudy -->

                        <!-- weather icon -->


                        <p data-weatherStatus class="text-2xl">

                        <div><img src="" width="90" data-weatherIcon></div>

                        </p>
                        <!-- temperature comes here -->
                        <p data-cityTemp class="text-5xl font-bold">

                        </p>

                    </div>
                    <!-- 2nd -->
                    <div class="flex flex-col md:flex-row items-center  gap-3 w-full">
                        <div class="w-[90%] max-w-[200px] rounded-md py-4 flex flex-col justify-center items-center"
                            style="background-color : rgba(219, 226, 239, 0.5);">
                            <!-- some windspeed icon will come here -->
                            <img src="./assets/wind.png" alt="" width="50">
                            <p class="text-2xl">WINDSPEED</p>
                            <p data-windSpeed class="text-xl">
                                <!-- windspeed comes here -->
                            </p>
                        </div>
                        <div class="w-[90%] max-w-[200px] rounded-md py-4 flex flex-col justify-center items-center "
                            style="background-color : rgba(219, 226, 239, 0.5);">
                            <img src="./assets/humidity.png" alt="" width="50">
                            <p class="text-2xl">HUMIDITY</p>
                            <p data-humidity class="text-xl">
                                <!-- humidity comes here -->
                            </p>
                        </div>
                        <div class="w-[90%] max-w-[200px] rounded-md py-4 flex flex-col justify-center items-center "
                            style="background-color : rgba(219, 226, 239, 0.5);">
                            <img src="./assets/cloud.png" alt="" width="50">
                            <p class="text-2xl">CLOUDS</p>
                            <p data-clouds class="text-xl">
                                <!-- clouds comes here -->
                            </p>
                        </div>
                    </div>
                </div>

                <!-- error city box -->
                <div class="error justify-center items-center gap-2">
                    <img src="./assets/not-found.png" height="200" width="300" alt="not found">
                    <p>City not found</p>
                </div>
            </div>




        </div>
    </div>

    <script>
        const API_KEY = "9b0db5c02a6bea1fafc467bc6973a7d7";
        let mydata;


        async function getWeather() {
            errorContainer.classList.remove('active');
            let city = inputBox.value;
            inputBox.value = "";
            // let city = "Bangalore";
            console.log("getting");
            try {
                const response = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_KEY}`
                );
                console.log(response);
                if (response.status === 200) {
                    console.log("hello")
                    const data = await response.json();
                    data.main.temp = kelvinToCelcius(data.main.temp);
                    showWeather(data);
                    console.log(kelvinToCelcius(data.main.temp) + "C");
                }
                else {
                    return "ERROR"
                }
            } catch (error) {

            }
        }
        function kelvinToCelcius(kelvin) {
            return (kelvin - 273.15).toFixed(2);
        }

        function showWeather(weatherData) {
            if (!weatherData) {
                return;
            }
            mydata = weatherData;
            cityName.innerText = weatherData.name;
            cityTemp.innerText = `${weatherData.main.temp} Â°C`;
            console.log(weatherData.weather[0].main);
            weatherStatus.textContent = weatherData.weather[0].main;

            clouds.textContent = weatherData.clouds.all + "%";
            windSpeed.textContent = weatherData.wind.speed + "m/s";
            humidity.textContent = weatherData.main.humidity + "%";

            countryIcon.src = `https://flagcdn.com/144x108/${weatherData?.sys?.country.toLowerCase()}.png`
            console.log("trying to put the icon")
            weatherIcon.src = `https://openweathermap.org/img/w/${weatherData?.weather?.[0]?.icon}.png`;
            console.log(weatherIcon.src)
        }
        const errorContainer = document.querySelector('.error');

        const inputBox = document.querySelector("[data-inputBox]");
        const searchIcon = document.querySelector("[data-searchIcon]");
        const cityData = document.querySelector("#cityResults");
        const cityName = document.querySelector("[data-cityName]");
        const cityTemp = document.querySelector("[data-cityTemp]");
        const weatherStatus = document.querySelector("[data-weatherStatus]");
        const countryIcon = document.querySelector("[data-countryIcon]");

        const weatherIcon = document.querySelector('[data-weatherIcon]');
        const windSpeed = document.querySelector("[data-windSpeed]");
        const humidity = document.querySelector("[data-humidity]");
        const clouds = document.querySelector("[data-clouds]");

        // const searchTab = document.querySelector('[data-searchTab]');
        const searchWeatherContainer = document.querySelector(
            "[data-searchWeatherContainer]"
        );

        const userTab = document.querySelector("[data-userWeather]");
        const searchTab = document.querySelector("[data-searchWeatherButton]");
        const grantLocationContainer = document.querySelector(
            "[data-grantLocationContainer]"
        );

        const loader = document.querySelector("[data-loader]");
        const userInfoContainer = document.querySelector("[data-userInfoContainer]");
        const grantLocationButton = document.querySelector(
            "[data-grantLocationButton]"
        );

        let currentTab = userTab;
        currentTab.classList.add("current-tab");

        userTab.addEventListener("click", () => {
            handleTabs(userTab);
        });
        getFromSessionStorage();

        searchTab.addEventListener("click", makeSearchWeatherVisible);

        function makeSearchWeatherVisible() {
            handleTabs(searchTab);
            // searchWeatherContainer.classList.add('active');
        }

        function handleTabs(clickedTab) {
            if (clickedTab !== currentTab) {
                currentTab.classList.remove("current-tab");
                currentTab = clickedTab;
                currentTab.classList.add("current-tab");

                // we know that the user has pressed on a different tab
                // but we dont know which he has pressed on, in order to know that we gotta check if the search container active class is there or not

                if (!searchWeatherContainer.classList.contains("active")) {
                    // this means that we need to do it visible
                    searchWeatherContainer.classList.add("active");
                    loader.classList.remove('active');
                    grantLocationContainer.classList.remove("active");
                    userInfoContainer.classList.remove("active");
                } else {
                    // we were previously on searchWeather container now we need to switch to the other tab
                    // that is your weather tab
                    searchWeatherContainer.classList.remove("active");
                    userInfoContainer.classList.remove("active");
                    errorContainer.classList.remove('active');
                    getFromSessionStorage();
                }
            }
        }

        function getFromSessionStorage() {
            let localCoordinates = sessionStorage?.getItem("co-ordinates");

            if (!localCoordinates) {
                grantLocationContainer.classList.add("active");
            } else {
                loader.classList.add("active");
                fetchUserWeatherDetailsOfCoordinates(JSON.parse(localCoordinates));
            }
        }

        grantLocationButton.addEventListener("click", getLocation);

        function getLocation() {
            // this will return user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                alert("fetching location is not possible");
            }
        }
        function showPosition(position) {
            let lat = position.coords.latitude;
            let long = position.coords.longitude;
            console.log("heelp");
            console.log(long);
            console.log(lat);
            let coordinates = {
                lon: long,
                lat: lat,
            };
            sessionStorage.setItem("co-ordinates", JSON.stringify(coordinates));
            grantLocationContainer.classList.remove("active");
            loader.classList.add('active');
            fetchUserWeatherDetailsOfCoordinates(coordinates);
        }

        async function fetchUserWeatherDetailsOfCoordinates(coordinates) {
            let { lon, lat } = coordinates;
            console.log("latitude : ", lat);
            console.log("longitude : ", lon);
            try {
                // api call based on coordinates
                console.log("fetching user details");
                let response = await fetch(
                    `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`
                );
                let results = await response.json();
                console.log(response);

                loader.classList.remove("active");
                userInfoContainer.classList.add("active");
                console.log(results);
                showWeather(results);

            } catch (error) {
                console.log("error is : ");
            }
        }
        let myForm = document.getElementById("form-data");

        myForm.addEventListener("submit", async (event) => {
            if (inputBox.value) {
                event.preventDefault();
                userInfoContainer.classList.remove('active');
                loader.classList.add("active");
                try {
                    if (await getWeather() !== 'ERROR') {
                        loader.classList.remove("active");
                        userInfoContainer.classList.add("active");

                    }
                    else {
                        console.log("caused error");
                        loader.classList.remove('active');
                        errorContainer.classList.add('active');
                    }
                } catch (error) {
                    console.log("Form was not submitted")
                }

                // makeCityDataVisible();
            } else {
                alert("Enter a city");
                return;
            }
        });

        //

    </script>
</body>

</html>